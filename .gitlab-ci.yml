default:
  image: mhart/alpine-node
cache:
  paths:
    - API/vendor/
    - API/node_modules/
    - web/node_modules/
stages:
  - build
  - test

# sast jobs
include:
  - template: Security/SAST.gitlab-ci.yml

api:build:
  image: edbizarro/gitlab-ci-pipeline-php:7.4
  stage: build
  only:
    changes:
      - "API/**/*"
      - ".gitlab-ci.yml"
  script:
    - cd API
    # Install Composer and project dependencies.
    - curl -sS https://getcomposer.org/installer | php
    - php composer.phar install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist
    # Environment
    - cp .env.testing .env
    # Generate an application key. Re-cache.
    - php artisan key:generate
    - php artisan config:cache
    # Run database migrations.
    - php artisan migrate
    # Passport keys
    - php artisan passport:keys

api:test:
  image: edbizarro/gitlab-ci-pipeline-php:7.4
  stage: test
  needs: ["api:build"]
  only:
    changes:
      - "API/**/*"
      - ".gitlab-ci.yml"
  script:
    - cd API
    # run laravel tests
    - php artisan test
    # run frontend tests
    # if you have any task for testing frontend
    # set it in your package.json script
    # comment this out if you don't have a frontend test
    #- npm test

web:build:
  stage: build
  only:
    changes:
      - "web/**/*"
      - ".gitlab-ci.yml"
  script:
    - cd web
    # install
    - yarn install

web:test:
  stage: test
  needs: ["web:build"]
  only:
    changes:
      - "web/**/*"
      - ".gitlab-ci.yml"
  script:
    - cd web
    # test
    - yarn test --watchAll=false
